import chai, {assert} from 'chai';
import chaiHttp from 'chai-http';
import server from '../../index';
import dotEnv from 'dotenv';

dotEnv.config();

chai.use(chaiHttp);

const tokens = {
	adminToken: null,
	normalUserToken: null,
	commentToken: null,
	postToken: null,
	fakeUserId: null
}

const fakeUsername = process.env.FAKE_USERNAME;
const fakeUser_Email = process.env.FAKE_USER_EMAIL;
const fakeUser_Pass = process.env.FAKE_USER_PASS;
const fakeRole = process.env.FAKE_ROLE;

const normalUser_Email = process.env.NORMAL_USER_EMAIL;
const normalUser_Pass = process.env.NORMAL_USER_PASS;
const normalUser_Role = process.env.NORMAL_USER_ROLE;

const guestUser_Role = process.env.GUEST_USER_ROLE;

const adminUser_Email = process.env.ADMIN_EMAIL;
const adminUser_Pass = process.env.ADMIN_PASS;
const adminUser_Role = process.env.ADMIN_USER_ROLE;

describe('Tests to API user routes (from admin page)', () => {
	it('(200 Success) GET /getUsers to get all users using admin token (usertoken)', done => {
		chai.request(server)
			.post('/login')
			.send({
				email: adminUser_Email,
				password: adminUser_Pass
			})
			.end((err, res) => {
				if (err) done(err);
				tokens.adminToken = res.body.userToken;
				chai.request(server)
					.get('/getUsers')
					.set('usertoken', tokens.adminToken)
					.end((err, res) => {
						if (err) done(err);
						assert.equal(res.status, 200);
						assert.deepPropertyVal(res.body, 'status', 'Success')
						done();
					})
			})
	});

	it('(403 Unauthorized) GET /getUsers with a normal user token (usertoken)', done => {
		chai.request(server)
			.post('/login')
			.send({
				email: normalUser_Email,
				password: normalUser_Pass
			})
			.end((err, res) => {
				if (err) done(err);
				tokens.normalUserToken = res.body.userToken;
				chai.request(server)
					.get('/getUsers')
					.set('usertoken', tokens.normalUserToken)
					.end((err, res) => {
						if (err) done(err);
						assert.equal(res.status, 403);
						assert.deepPropertyVal(res.body, 'status', 'Unauthorized')
						done();
					})
			})
	});

	it('(403 Unauthorized) GET /getUsers to get all users but without a user token', done => {
		chai.request(server)
			.get('/getUsers')
			.end((err, res) => {
				if (err) done(err);
				assert.equal(res.status, 403);
				assert.deepPropertyVal(res.body, 'status', 'Unauthorized')
				done();
			});
	})

	it('(403 Forbidden) GET /getUsers to get all users with an invalid user token', done => {
		chai.request(server)
			.get('/getUsers')
			.set('usertoken', 'jkljkljkljj')
			.end((err, res) => {
				if (err) done(err);
				assert.equal(res.status, 403);
				assert.deepPropertyVal(res.body, 'status', 'Forbidden')
				done();
			});
	})

	it('(403 Unauthorized) DELETE /deleteUser to delete a user from the user profile page by supplying an invalid user token (usertoken)', done => {
		chai.request(server)
			.delete('/deleteUser')
			.set('usertoken', 'jkljkljkljj')
			.end((err, res) => {
				if (err) done(err);
				assert.equal(res.status, 403);
				assert.deepPropertyVal(res.body, 'status', 'Forbidden')
				done();
			});
	})

	it('(200 Success) DELETE /deleteUser to delete a user from the user profile page by supplying a valid user token (usertoken)', done => {
		chai.request(server)
			.post('/login')
			.send({
				email: fakeUser_Email,
				password: fakeUser_Pass
			})
			.end((err, res) => {
				if (err) done(err);
				chai.request(server)
					.delete('/deleteUser')
					.set('usertoken', res.body.userToken)
					.end((err, res) => {
						if (err) done(err);
						assert.equal(res.status, 200);
						assert.deepPropertyVal(res.body, 'status', 'user successfully deleted')
						done();
					});
			})
	})

	it('(200 Success) DELETE /deleteUser to delete a user from the admin page by supplying a valid admin user token (usertoken) and a userid (userid)', done => {
		chai.request(server)
            .post('/signup')
            .send({
                username: fakeUsername,
                email: fakeUser_Email,
                password: fakeUser_Pass,
                role: normalUser_Role,
                subscribed: 'no'
            })
			.end((err, res) => {
				if (err) done(err);
				chai.request(server)
					.delete('/deleteUser')
					.set('usertoken', tokens.adminToken)
					.send({
						userid: res.body.userId
					})
					.end((err, res) => {
						if (err) done(err);
						assert.equal(res.status, 200);
						assert.deepPropertyVal(res.body, 'status', 'user successfully deleted')
						done();
					});
			})
	})
})